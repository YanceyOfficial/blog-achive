# [HTTP 系列] 第 5 篇 —— 网络安全

## 洪泛攻击

在三次握手过程中. 服务器发送 SYN-ACK 之后. 收到客户端的 ACK 之前的 TCP 连接称为半连接(half-open connect). 此时服务器处于 SYN_RCVD 状态. 当收到 ACK 后. 服务器才能转入 ESTABLISHED 状态.

所以在短时间内伪造大量的不存在的 IP. 向服务器不断发送 SYN 包. 由于源地址是不存在的. 服务器需要不断的向客户端重新发送 `SYN/ACK` 直到超时. 这些伪造的 SYN 包将长时间占用未连接队列. 而正常的 SYN 被丢弃. 因此洪泛攻击会导致服务器运行缓慢. 严重会引起网络堵塞甚至系统瘫痪. 洪泛攻击是一种典型的 DoS/DDoS 攻击. 当你的服务器出现大量的 `半连接`. 几乎就可以认为遭受到了洪泛攻击.

如何预防洪泛攻击呢? 完全阻止是不可能的. 毕竟敌人在暗处. 服务器在明处. 网上介绍了几种方式: **缩短 SYN 超时时间**. **增加最大半连接数**. **过滤网关防护**. **SYN cookies** 等. 不过我认为这些方法都没什么卵用. 还是老老实实买 DDoS 高防吧.

## 网络应用防火墙(Web Application Firewall)

传统**防火墙**工作在三层或者四层, 隔离了外网和内网, 使用预设的规则, 只允许某些特定 IP 地址和端口号的数据包通过, 拒绝不符合条件的数据流入或流出内网, 实质上是一种**网络数据过滤设备**. WAF 也是一种**防火墙**, 但它工作在七层, 看到的不仅是 IP 地址和端口号, 还能看到整个 HTTP 报文, 所以就能够对报文内容做更深入细致的审核, 使用更复杂的条件, 规则来过滤数据. 换句话说, WAF 就是一种 **HTTP 入侵检测和防御系统**.

![WAF](https://edge.yancey.app/beg/lqnvac7f-1649102511012.webp)

WAF 一般应该具有以下功能:

- IP 黑名单和白名单, 拒绝黑名单上地址的访问, 或者只允许白名单上的用户访问；
- URI 黑名单和白名单, 与 IP 黑白名单类似, 允许或禁止对某些 URI 的访问；
- 防护 DDoS 攻击, 对特定的 IP 地址限连限速；
- 过滤请求报文, 防御**代码注入**攻击；
- 过滤响应报文, 防御敏感信息外泄；
- 审计日志, 记录所有检测到的入侵操作.

WAF 的基本原理就好像是平时编写程序时必须要做的函数入口参数检查, 拿到 HTTP 请求, 响应报文, 用字符串处理函数看看有没有关键字, 敏感词, 或者用正则表达式做一下模式匹配, 命中了规则就执行对应的动作, 比如返回 403/404. 比如下面的例子就是利用 **map** 指令在 Nginx 里实现 IP 地址黑名单.

```shell
map $remote_addr $blocked {
    default       0;
    "1.2.3.4"     1;
    "5.6.7.8"     1;
}


if ($blocked) {
    return 403 "you are blocked.";
}
```

[ModSecurity](https://github.com/SpiderLabs/ModSecurity) 是开源的 WAF 软件, 它有两个核心组件. 第一个是**规则引擎**, 它实现了自定义的**SecRule**语言, 有自己特定的语法. 但**SecRule**主要基于正则表达式, 还是不够灵活, 所以后来也引入了 Lua, 实现了脚本化配置. 只有引擎还不够, 要让引擎运转起来, 还需要完善的防御规则, 所以 ModSecurity 的第二个核心组件就是它的**规则集**.

基本的规则集之外, ModSecurity 还额外提供一个更完善的规则集, 为网站提供全面可靠的保护. 这个规则集的全名叫**OWASP ModSecurity 核心规则集**(Open Web Application Security Project ModSecurity Core Rule Set).

![CRS](https://edge.yancey.app/beg/k94eh2lq-1649102502087.webp)

另外, ModSecurity 还有强大的审计日志(Audit Log)功能, 记录任何可疑的数据, 供事后离线分析. 但在生产环境中会遇到大量的攻击, 日志会快速增长, 消耗磁盘空间, 而且写磁盘也会影响 Nginx 的性能, 所以一般建议把它关闭：

```shell
SecAuditEngine off  #RelevantOnly
SecAuditLog /var/log/modsec_audit.log
```

因此, WAF 实质上是模式匹配与数据过滤, 所以会消耗 CPU, 增加一些计算成本, 降低服务能力, 使用时需要在安全与性能之间找到一个**平衡点**.
